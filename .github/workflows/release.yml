name: Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-and-package:
    runs-on: ubuntu-latest

    steps:
      - name: Ensure workflow runs on a tag
        run: |
          if [[ "${GITHUB_REF}" != refs/tags/* ]]; then
            echo "::error::Please run this workflow from a tag (Run workflow ▶ select Tag)."
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Disable man-db auto-update
        run: |
          sudo rm -f /var/lib/man-db/auto-update || true
          sudo ln --symbolic --force "$(command -v true)" /usr/bin/mandb || true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ms-playwright
            ~/.cache/playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run quality gate
        run: npm run check

      - name: Build extension
        run: npm run build

      - name: Create distributable archive
        run: |
          cd dist
          zip -r ../pan-transfer-extension.zip .

      - name: Generate release notes
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo '')
          if [ -n "$PREVIOUS_TAG" ]; then
            git log --pretty=format:'- %s' "$PREVIOUS_TAG"..HEAD > .release-changes.tmp || true
          else
            git log -10 --pretty=format:'- %s' > .release-changes.tmp || true
          fi
          if [ ! -s .release-changes.tmp ]; then
            echo '- No commit summaries available.' > .release-changes.tmp
          fi
          python <<'PY'
          from pathlib import Path

          header = """## Installation / 安装
          1. Download `pan-transfer-extension.zip` from the Assets section below. / 在下方 Assets 区域下载 `pan-transfer-extension.zip`。
          2. Extract the archive to a local folder. / 将压缩包解压到本地目录。
          3. Open `chrome://extensions/` (or `edge://extensions/`), enable Developer Mode, choose **Load unpacked**, and select the extracted `dist/` content. / 打开 `chrome://extensions/`（或 `edge://extensions/`），开启开发者模式，点击“加载已解压的扩展程序”，选择解压后的 `dist/`。

          ## Changes / 更新内容
          """

          changes = Path('.release-changes.tmp').read_text(encoding='utf-8')
          Path('release-notes.md').write_text(header + changes + ("\n" if not changes.endswith("\n") else ''), encoding='utf-8')
          PY

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: pan-transfer-extension
          path: pan-transfer-extension.zip

      - name: Publish tag release asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: pan-transfer-extension.zip
          body_path: release-notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
