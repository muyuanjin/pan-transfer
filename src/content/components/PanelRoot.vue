<template>
  <div ref="panelRef" :class="panelClasses">
    <div ref="headerRef" class="chaospace-float-header">
      <div class="chaospace-header-art is-empty" data-role="header-art"></div>
      <div ref="headerActionsRef" class="chaospace-header-actions">
        <button
          type="button"
          class="chaospace-theme-toggle"
          data-role="theme-toggle"
          aria-label="åˆ‡æ¢ä¸»é¢˜"
          title="åˆ‡æ¢ä¸»é¢˜"
        >
          â˜€ï¸
        </button>
        <button
          type="button"
          class="chaospace-settings-toggle"
          data-role="settings-toggle"
          aria-label="æ‰“å¼€è®¾ç½®"
          title="æ’ä»¶è®¾ç½®"
          aria-expanded="false"
        >
          âš™ï¸
        </button>
        <button
          type="button"
          class="chaospace-float-pin"
          data-role="pin-toggle"
          title="å›ºå®šé¢æ¿"
          aria-pressed="false"
        >
          ğŸ“Œ
        </button>
      </div>
      <div class="chaospace-header-content">
        <img
          class="chaospace-header-poster"
          data-role="header-poster"
          alt=""
          loading="lazy"
          decoding="async"
          draggable="false"
          style="display: none"
        />
        <div ref="headerBodyRef" class="chaospace-header-body">
          <h2 class="chaospace-show-title" data-role="show-title">{{ safeTitle }}</h2>
          <ProviderStatusBar />
        </div>
      </div>
    </div>
    <div class="chaospace-float-body">
      <div class="chaospace-history-overlay" data-role="history-overlay" aria-hidden="true">
        <div class="chaospace-history-overlay-header">
          <div class="chaospace-history-overlay-title">ğŸ”– è½¬å­˜å†å²</div>
          <button
            type="button"
            class="chaospace-history-toggle"
            data-role="history-toggle"
            aria-expanded="false"
            aria-label="æ”¶èµ·è½¬å­˜å†å²"
          >
            æ”¶èµ·
          </button>
        </div>
        <div class="chaospace-history-controls" data-role="history-controls">
          <HistoryFilterTabs />
          <HistorySearchBar />
          <HistoryToolbar />
        </div>
        <div class="chaospace-history-overlay-scroll" data-role="history-scroll">
          <div class="chaospace-history-empty" data-role="history-empty">è¿˜æ²¡æœ‰è½¬å­˜è®°å½•</div>
          <div class="chaospace-history-list" data-role="history-list"></div>
        </div>
      </div>
      <div class="chaospace-settings-overlay" data-role="settings-overlay" aria-hidden="true">
        <div
          class="chaospace-settings-dialog"
          role="dialog"
          aria-modal="true"
          aria-labelledby="chaospace-settings-title"
        >
          <div class="chaospace-settings-header">
            <div id="chaospace-settings-title" class="chaospace-settings-title">âš™ï¸ æ’ä»¶è®¾ç½®</div>
            <button
              type="button"
              class="chaospace-settings-close"
              data-role="settings-close"
              aria-label="å…³é—­è®¾ç½®"
            >
              âœ•
            </button>
          </div>
          <div class="chaospace-settings-body">
            <form
              id="chaospace-settings-form"
              class="chaospace-settings-form"
              data-role="settings-form"
            >
              <section class="chaospace-settings-section">
                <h3>ç›®å½•ç­–ç•¥</h3>
                <div class="chaospace-settings-field">
                  <label class="chaospace-settings-label" for="chaospace-settings-base-dir"
                    >åŸºç¡€è½¬å­˜ç›®å½•</label
                  >
                  <input
                    id="chaospace-settings-base-dir"
                    type="text"
                    placeholder="/è§†é¢‘/ç•ªå‰§"
                    data-role="settings-base-dir"
                  />
                  <p class="chaospace-settings-hint">
                    å­—ç¬¦ä¸² Â· ä»¥ / å¼€å¤´ï¼Œä½œä¸ºæ‰€æœ‰è½¬å­˜è®°å½•çš„æ ¹ç›®å½•ã€‚
                  </p>
                </div>
                <div class="chaospace-settings-field">
                  <label class="chaospace-settings-checkbox" for="chaospace-settings-use-title">
                    <input
                      id="chaospace-settings-use-title"
                      type="checkbox"
                      data-role="settings-use-title"
                    />
                    <div>
                      <span>æŒ‰å‰§ååˆ›å»ºå­ç›®å½•</span>
                      <p class="chaospace-settings-hint">
                        å¸ƒå°”å€¼ Â· å‹¾é€‰åä½¿ç”¨å½“å‰é¡µé¢æ ‡é¢˜ä½œä¸ºå­æ–‡ä»¶å¤¹åç§°ã€‚
                      </p>
                    </div>
                  </label>
                  <label class="chaospace-settings-checkbox" for="chaospace-settings-use-season">
                    <input
                      id="chaospace-settings-use-season"
                      type="checkbox"
                      data-role="settings-use-season"
                    />
                    <div>
                      <span>æŒ‰å­£æ‹†åˆ†å­ç›®å½•</span>
                      <p class="chaospace-settings-hint">å¸ƒå°”å€¼ Â· å‹¾é€‰åä¸ºæ¯å­£å•ç‹¬åˆ›å»ºæ–‡ä»¶å¤¹ã€‚</p>
                    </div>
                  </label>
                </div>
                <div class="chaospace-settings-field">
                  <label class="chaospace-settings-label" for="chaospace-settings-presets"
                    >æ”¶è—è·¯å¾„åˆ—è¡¨</label
                  >
                  <textarea
                    id="chaospace-settings-presets"
                    rows="4"
                    data-role="settings-presets"
                    placeholder="/è§†é¢‘/ç•ªå‰§&#10;/è§†é¢‘/å½±è§†"
                  ></textarea>
                  <p class="chaospace-settings-hint">
                    å­—ç¬¦ä¸²æ•°ç»„ Â· æ¯è¡Œä¸€ä¸ªè·¯å¾„ï¼Œä¿å­˜åè‡ªåŠ¨å»é‡å¹¶ä¿ç•™é»˜è®¤ç¤ºä¾‹ã€‚
                  </p>
                </div>
              </section>
              <section class="chaospace-settings-section">
                <h3>ä½“éªŒä¸é™é€Ÿ</h3>
                <div class="chaospace-settings-field">
                  <div class="chaospace-settings-label">ç•Œé¢ä¸»é¢˜</div>
                  <div
                    class="chaospace-segmented chaospace-segmented--settings"
                    data-role="settings-theme"
                    role="radiogroup"
                    aria-label="ç•Œé¢ä¸»é¢˜"
                  >
                    <button
                      type="button"
                      class="chaospace-segmented-option"
                      data-value="dark"
                      role="radio"
                      aria-checked="false"
                    >
                      æ·±è‰²
                    </button>
                    <button
                      type="button"
                      class="chaospace-segmented-option"
                      data-value="light"
                      role="radio"
                      aria-checked="false"
                    >
                      æµ…è‰²
                    </button>
                  </div>
                  <p class="chaospace-settings-hint">æšä¸¾å€¼ Â· å½±å“æµ®åŠ¨é¢æ¿çš„èƒŒæ™¯ä¸æ–‡å­—æ ·å¼ã€‚</p>
                </div>
                <div class="chaospace-settings-field">
                  <label class="chaospace-settings-label" for="chaospace-settings-history-rate"
                    >æ‰¹é‡æ£€æµ‹é—´éš”ï¼ˆç§’ï¼‰</label
                  >
                  <input
                    id="chaospace-settings-history-rate"
                    type="number"
                    min="0.5"
                    max="60"
                    step="0.5"
                    data-role="settings-history-rate"
                  />
                  <p class="chaospace-settings-hint">
                    æ•°å­— Â· æ§åˆ¶æ‰¹é‡åˆ·æ–°å†å²æ—¶çš„æœ€å°å»¶è¿Ÿï¼Œé¿å…è§¦å‘é£æ§ï¼ˆ0.5ï½60 ç§’ï¼‰ã€‚
                  </p>
                </div>
              </section>
              <section class="chaospace-settings-section">
                <h3>è§£æå™¨ç®¡ç†</h3>
                <div class="chaospace-settings-field">
                  <div class="chaospace-settings-label">ç«™ç‚¹è§£æå™¨</div>
                  <div
                    class="chaospace-provider-settings"
                    data-role="settings-site-provider-list"
                  ></div>
                  <p class="chaospace-settings-hint">
                    å¯æŒ‰éœ€ç¦ç”¨æš‚ä¸éœ€è¦çš„ç«™ç‚¹è§£æå™¨ï¼Œé¿å…åœ¨ä¸å…¼å®¹é¡µé¢ä¸Šè§¦å‘è¯¯æŠ¥ã€‚
                  </p>
                </div>
              </section>
              <section class="chaospace-settings-section">
                <h3>æ–‡ä»¶è¿‡æ»¤</h3>
                <div class="chaospace-settings-field">
                  <label class="chaospace-settings-label" for="chaospace-settings-filter-mode"
                    >å‘½ä¸­ä¼˜å…ˆçº§</label
                  >
                  <select id="chaospace-settings-filter-mode" data-role="settings-filter-mode">
                    <option value="deny-first">å¦å†³ä¼˜å…ˆï¼ˆå‘½ä¸­å‰”é™¤è§„åˆ™å³è·³è¿‡ï¼‰</option>
                    <option value="allow-first">æ¥å—ä¼˜å…ˆï¼ˆå‘½ä¸­ä¿ç•™è§„åˆ™å³ä¿ç•™ï¼‰</option>
                    <option value="ordered">æŒ‰é¡ºåºä¼˜å…ˆï¼ˆé¦–ä¸ªå‘½ä¸­è§„åˆ™ç”Ÿæ•ˆï¼‰</option>
                  </select>
                  <p class="chaospace-settings-hint">æšä¸¾å€¼ Â· æ§åˆ¶å¤šä¸ªè§„åˆ™åŒæ—¶å‘½ä¸­æ—¶çš„å†³ç­–é¡ºåºã€‚</p>
                </div>
                <div class="chaospace-settings-field">
                  <div class="chaospace-settings-label">è¿‡æ»¤è§„åˆ™</div>
                  <div
                    class="chaospace-rule-editor"
                    data-role="settings-filter-editor"
                    aria-live="polite"
                  ></div>
                  <p class="chaospace-settings-hint">
                    é€æ¡å®šä¹‰ç­›é€‰æ¡ä»¶ï¼Œæ”¯æŒæŒ‰åç§°ã€æ­£åˆ™ã€å¤§å°ã€æ‰©å±•åã€ç±»åˆ«æˆ–ç›®å½•çŠ¶æ€è¿‡æ»¤ã€‚å‘½ä¸­ä¼˜å…ˆçº§ç»“åˆä¸‹æ–¹è§„åˆ™é¡ºåºå…±åŒå†³å®šæœ€ç»ˆç»“æœã€‚
                  </p>
                </div>
              </section>
              <section class="chaospace-settings-section">
                <h3>æ–‡ä»¶é‡å‘½å</h3>
                <div class="chaospace-settings-field">
                  <div class="chaospace-settings-label">é‡å‘½åè§„åˆ™</div>
                  <div
                    class="chaospace-rule-editor"
                    data-role="settings-rename-editor"
                    aria-live="polite"
                  ></div>
                  <p class="chaospace-settings-hint">
                    ä¾æ¬¡å¯¹æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰æ‰§è¡Œæ­£åˆ™æ›¿æ¢ï¼Œå¯é…ç½®æè¿°ã€å¼€å…³ã€æ­£åˆ™è¡¨è¾¾å¼ä¸æ›¿æ¢ç»“æœï¼Œæ”¯æŒè‡ªå®šä¹‰
                    flagsã€‚
                  </p>
                </div>
              </section>
              <section class="chaospace-settings-section">
                <h3>é«˜çº§æ“ä½œ</h3>
                <div class="chaospace-settings-row">
                  <div>
                    <div class="chaospace-settings-row-title">é‡ç½®é¢æ¿å¸ƒå±€</div>
                    <p class="chaospace-settings-hint">æ¸…ç†å·²ä¿å­˜çš„å¤§å°ä¸ä½ç½®ï¼Œæ¢å¤é»˜è®¤æ‘†æ”¾ã€‚</p>
                  </div>
                  <button type="button" data-role="settings-reset-layout">é‡ç½®</button>
                </div>
              </section>
              <input
                type="file"
                data-role="settings-import-data"
                accept="application/json"
                hidden
              />
            </form>
            <div class="chaospace-settings-footer">
              <div class="chaospace-settings-footer-actions" aria-label="æ•°æ®å¯¼å…¥å¯¼å‡º">
                <button type="button" data-role="settings-export-data">
                  <span class="chaospace-settings-action-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" focusable="false" fill="currentColor">
                      <path
                        fill-rule="evenodd"
                        clip-rule="evenodd"
                        d="M11.4697 2.46967c.2929-.29289.7677-.29289 1.0606 0l4.5 4.5c.2929.29289.2929.76767 0 1.06056-.2929.29289-.7677.29289-1.0606 0L12.75 4.81066V16.5A.75.75 0 0 1 12 17.25a.75.75 0 0 1-.75-.75V4.81066L8.03033 8.03023c-.29289.29289-.76767.29289-1.06066 0-.29289-.29289-.29289-.76767 0-1.06056l4.5-4.5Zm-8.4697 13.28033c.41421 0 .75.3358.75.75v2.25c0 .8284.67157 1.5 1.5 1.5h13.5c.8284 0 1.5-.6716 1.5-1.5v-2.25c0-.4142.3358-.75.75-.75s.75.3358.75.75v2.25c0 1.6569-1.3431 3-3 3H5.25c-1.65685 0-3-1.3431-3-3v-2.25c0-.4142.33579-.75.75-.75Z"
                      />
                    </svg>
                  </span>
                  <span>å¯¼å‡ºæ•°æ®</span>
                </button>
                <button type="button" data-role="settings-import-data-trigger">
                  <span class="chaospace-settings-action-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" focusable="false" fill="currentColor">
                      <path
                        fill-rule="evenodd"
                        clip-rule="evenodd"
                        d="M12 2.25c.4142 0 .75.33579.75.75v11.6893l3.2197-3.2196c.2929-.2929.7677-.2929 1.0606 0 .2929.2929.2929.7677 0 1.0606l-4.5 4.5a.75.75 0 0 1-1.0606 0l-4.5-4.5c-.29289-.2929-.29289-.7677 0-1.0606s.76767-.2929 1.06056 0L11.25 14.6896V3a.75.75 0 0 1 .75-.75Zm-9 13.5c.41421 0 .75.3358.75.75v2.25c0 .8284.67157 1.5 1.5 1.5h13.5c.8284 0 1.5-.6716 1.5-1.5v-2.25c0-.4142.3358-.75.75-.75s.75.3358.75.75v2.25c0 1.6569-1.3431 3-3 3H5.25c-1.65685 0-3-1.3431-3-3v-2.25c0-.4142.33579-.75.75-.75Z"
                      />
                    </svg>
                  </span>
                  <span>å¯¼å…¥æ•°æ®</span>
                </button>
              </div>
              <div class="chaospace-settings-footer-primary">
                <button type="button" data-role="settings-cancel">
                  <span class="chaospace-settings-action-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" focusable="false" fill="currentColor">
                      <path
                        fill-rule="evenodd"
                        clip-rule="evenodd"
                        d="M9.53033 2.46967c.29289.29289.29289.76767 0 1.06066L4.81066 8.25H15c3.7279 0 6.75 3.0221 6.75 6.75s-3.0221 6.75-6.75 6.75h-3a.75.75 0 0 1 0-1.5h3c2.8995 0 5.25-2.3505 5.25-5.25S17.8995 9.75 15 9.75H4.81066l4.71967 4.7197c.29289.2929.29289.7677 0 1.0606s-.76767.2929-1.06066 0l-6-6a.75.75 0 0 1 0-1.06061l6-6c.29299-.29289.76777-.29289 1.06066 0Z"
                      />
                    </svg>
                  </span>
                  <span>å–æ¶ˆ</span>
                </button>
                <button
                  type="submit"
                  class="chaospace-settings-save"
                  form="chaospace-settings-form"
                >
                  <span class="chaospace-settings-action-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" focusable="false" fill="currentColor">
                      <path
                        fill-rule="evenodd"
                        clip-rule="evenodd"
                        d="M2.25 12C2.25 6.61522 6.61522 2.25 12 2.25S21.75 6.61522 21.75 12 17.3848 21.75 12 21.75 2.25 17.3848 2.25 12Zm13.3603-1.8141c.2408-.33703.1627-.80544-.1743-1.0462-.337-.24076-.8054-.16269-1.0462.17437l-3.2354 4.52953-1.624-1.62393a.75.75 0 1 0-1.06063 1.06063l2.25003 2.25003c.15587.1559.37237.2353.59217.2171.2197-.0181.4204-.1321.5485-.3115l3.75-5.24993Z"
                      />
                    </svg>
                  </span>
                  <span>ä¿å­˜è®¾ç½®</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="chaospace-float-main">
        <div class="chaospace-float-columns">
          <section class="chaospace-column chaospace-column-left">
            <div class="chaospace-section-heading">
              <div class="chaospace-section-title" data-role="resource-title"></div>
              <div class="chaospace-section-caption" data-role="resource-summary"></div>
            </div>
            <div class="chaospace-season-tabs" data-role="season-tabs" hidden></div>
            <PanelToolbar />
            <div class="chaospace-items-scroll" data-role="items"></div>
          </section>
          <section class="chaospace-column chaospace-column-right">
            <div class="chaospace-card chaospace-path-card">
              <div class="chaospace-card-title">ğŸ“ è½¬å­˜ç›®å½•</div>
              <div class="chaospace-card-body">
                <PresetList />
                <div class="chaospace-input-row">
                  <input type="text" placeholder="/è§†é¢‘/ç•ªå‰§" data-role="base-dir" />
                  <button type="button" data-role="add-preset">æ”¶è—è·¯å¾„</button>
                </div>
                <label class="chaospace-checkbox">
                  <input type="checkbox" data-role="use-title" />
                  <span>ä¸ºæœ¬é¡µåˆ›å»ºå­ç›®å½•ï¼ˆæ¨èï¼‰</span>
                </label>
                <label
                  class="chaospace-checkbox chaospace-season-checkbox"
                  data-role="season-row"
                  style="display: none"
                >
                  <input type="checkbox" data-role="use-season" />
                  <span>ä¸ºæ¯å­£åˆ›å»ºå­æ–‡ä»¶å¤¹</span>
                </label>
                <div class="chaospace-path-preview" data-role="path-preview"></div>
                <div class="chaospace-path-hint is-empty" data-role="season-path-hint"></div>
              </div>
            </div>
            <div class="chaospace-card chaospace-status-card">
              <div class="chaospace-card-title chaospace-log-header">
                <span class="chaospace-log-title">ğŸ“œ æ—¥å¿—</span>
                <div class="chaospace-log-summary is-empty" data-role="result-summary"></div>
              </div>
              <div class="chaospace-log-container" data-role="log-container">
                <ul class="chaospace-log-list" data-role="log-list"></ul>
              </div>
            </div>
          </section>
        </div>
      </div>
      <div class="chaospace-float-footer">
        <div class="chaospace-history-summary" data-role="history-summary">
          <div class="chaospace-history-summary-body" data-role="history-summary-body"></div>
        </div>
        <div class="chaospace-transfer-card chaospace-footer-actions">
          <button class="chaospace-float-btn chaospace-float-btn-compact" data-role="transfer-btn">
            <span class="chaospace-btn-spinner" data-role="transfer-spinner"></span>
            <span data-role="transfer-label">å¼€å§‹è½¬å­˜</span>
            <span class="chaospace-btn-icon">ğŸš€</span>
          </button>
        </div>
      </div>
    </div>
    <div
      class="chaospace-resize-handle"
      data-role="resize-handle"
      title="æ‹–åŠ¨è°ƒæ•´é¢æ¿å¤§å°"
      aria-hidden="true"
    ></div>
  </div>
</template>

<script setup lang="ts">
import { computed, nextTick, onBeforeUnmount, onMounted, ref, watch } from 'vue'
import PanelToolbar from './PanelToolbar.vue'
import HistoryFilterTabs from './history/HistoryFilterTabs.vue'
import HistorySearchBar from './history/HistorySearchBar.vue'
import HistoryToolbar from './history/HistoryToolbar.vue'
import PresetList from './PresetList.vue'
import ProviderStatusBar from './ProviderStatusBar.vue'

type PanelTheme = 'light' | 'dark'

const props = withDefaults(
  defineProps<{
    pageTitle?: string
    theme?: PanelTheme
  }>(),
  {
    pageTitle: '',
    theme: 'dark',
  },
)

const safeTitle = computed(() => props.pageTitle?.trim() || 'ç­‰å¾…é€‰æ‹©å‰§é›†')

const panelClasses = computed(() => ({
  'chaospace-float-panel': true,
  'chaospace-theme': true,
  'theme-light': props.theme === 'light',
}))

const MIN_POSTER_HEIGHT = 110
const DEFAULT_MAX_POSTER_HEIGHT = 220
const WIDTH_LIMIT_RATIO = 0.52
const HEIGHT_LIMIT_RATIO = 0.42

const panelRef = ref<HTMLElement | null>(null)
const headerRef = ref<HTMLElement | null>(null)
const headerActionsRef = ref<HTMLElement | null>(null)
const headerBodyRef = ref<HTMLElement | null>(null)
let headerBodyObserver: ResizeObserver | null = null
let headerActionsObserver: ResizeObserver | null = null
let currentPosterHeight = ''
let isPosterHeightMeasuring = false
let currentHeaderActionsLane = ''

const clampPosterHeight = (value: number, panelEl: HTMLElement): number => {
  if (!Number.isFinite(value) || value <= 0) {
    return MIN_POSTER_HEIGHT
  }
  let posterLimit = DEFAULT_MAX_POSTER_HEIGHT
  const panelBounds = panelEl.getBoundingClientRect()
  if (Number.isFinite(panelBounds.width) && panelBounds.width > 0) {
    posterLimit = Math.min(posterLimit, panelBounds.width * WIDTH_LIMIT_RATIO)
  }
  if (Number.isFinite(panelBounds.height) && panelBounds.height > 0) {
    posterLimit = Math.min(posterLimit, panelBounds.height * HEIGHT_LIMIT_RATIO)
  }
  const normalizedLimit = Math.max(MIN_POSTER_HEIGHT, Math.floor(posterLimit))
  const normalizedValue = Math.max(MIN_POSTER_HEIGHT, Math.round(value))
  return Math.min(normalizedValue, normalizedLimit)
}

const updatePosterHeight = () => {
  if (isPosterHeightMeasuring) {
    return
  }
  const panelEl = panelRef.value
  const headerBodyEl = headerBodyRef.value
  if (!panelEl || !headerBodyEl) {
    return
  }
  isPosterHeightMeasuring = true
  try {
    const previousAlignSelf = headerBodyEl.style.alignSelf
    const previousMinHeight = headerBodyEl.style.minHeight
    let measuredHeight = 0
    try {
      // æš‚æ—¶å…³é—­æ‹‰ä¼¸ä¸æœ€å°é«˜åº¦é™åˆ¶ï¼Œç¡®ä¿æµ‹é‡åˆ°çœŸå®å†…å®¹é«˜åº¦ã€‚
      headerBodyEl.style.alignSelf = 'flex-start'
      headerBodyEl.style.minHeight = '0px'
      measuredHeight = headerBodyEl.getBoundingClientRect().height
    } finally {
      headerBodyEl.style.alignSelf = previousAlignSelf
      headerBodyEl.style.minHeight = previousMinHeight
    }
    if (!Number.isFinite(measuredHeight) || measuredHeight <= 0) {
      measuredHeight = headerBodyEl.scrollHeight
    }
    if (!Number.isFinite(measuredHeight) || measuredHeight <= 0) {
      return
    }
    const computedHeight = clampPosterHeight(measuredHeight, panelEl)
    const formatted = `${computedHeight}px`
    if (formatted === currentPosterHeight) {
      return
    }
    currentPosterHeight = formatted
    panelEl.style.setProperty('--chaospace-header-poster-height', formatted)
  } finally {
    isPosterHeightMeasuring = false
  }
}

const setupHeaderObserver = () => {
  headerBodyObserver?.disconnect()
  if (typeof ResizeObserver === 'undefined' || !headerBodyRef.value) {
    return
  }
  headerBodyObserver = new ResizeObserver(() => updatePosterHeight())
  headerBodyObserver.observe(headerBodyRef.value)
}

const teardownHeaderObserver = () => {
  headerBodyObserver?.disconnect()
  headerBodyObserver = null
}

const updateHeaderActionsLane = () => {
  const headerEl = headerRef.value
  const actionsEl = headerActionsRef.value
  if (!headerEl || !actionsEl) {
    return
  }
  const { width } = actionsEl.getBoundingClientRect()
  if (!Number.isFinite(width) || width <= 0) {
    return
  }
  const formatted = `${Math.ceil(width)}px`
  if (formatted === currentHeaderActionsLane) {
    return
  }
  currentHeaderActionsLane = formatted
  headerEl.style.setProperty('--chaospace-header-actions-lane', formatted)
}

const setupHeaderActionsObserver = () => {
  headerActionsObserver?.disconnect()
  if (typeof ResizeObserver === 'undefined' || !headerActionsRef.value) {
    return
  }
  headerActionsObserver = new ResizeObserver(() => updateHeaderActionsLane())
  headerActionsObserver.observe(headerActionsRef.value)
}

const teardownHeaderActionsObserver = () => {
  headerActionsObserver?.disconnect()
  headerActionsObserver = null
}

const updateHeaderMetrics = () => {
  updatePosterHeight()
  updateHeaderActionsLane()
}

onMounted(() => {
  nextTick(() => {
    updateHeaderMetrics()
    setupHeaderObserver()
    setupHeaderActionsObserver()
    window.addEventListener('resize', updateHeaderMetrics)
  })
})

onBeforeUnmount(() => {
  window.removeEventListener('resize', updateHeaderMetrics)
  teardownHeaderObserver()
  teardownHeaderActionsObserver()
})

watch(
  () => props.pageTitle,
  () => {
    nextTick(() => updateHeaderMetrics())
  },
)
</script>
