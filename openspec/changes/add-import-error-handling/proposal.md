# Change Proposal: 导入错误处理增强

- **Change ID**: add-import-error-handling
- **Status**: Draft
- **Author**: Codex (AI)
- **Created**: 2025-11-14

## 背景

设置面板中的「导入数据」流程目前只做了极简校验：

1. 解析 JSON 文本；
2. 判断 `type` 字段是否等于 `chaospace-transfer-backup`；
3. 检查备份范围是否包含可导入内容。

一旦 JSON 结构缺失、版本不符、或某字段与预期 schema 不一致，系统仅返回「导入失败」+ 异常 message，用户无法得知具体原因，也不能快速修复备份文件。

## 目标

为备份导入流程提供可定位的错误提示与降级导入能力，覆盖以下场景：

- 文件不是合法 JSON；
- 备份 `version` 或 `type` 与当前应用不兼容；
- 关键 section 缺失或被清空（history/resources/settings 等）；
- 某字段结构错误时明确列出字段路径及期望类型；
- 当局部 section 损坏时，仍可导入其它完好 section，并把损坏信息反馈给用户。

## 范围

- 扩展设置面板导入流程的校验逻辑。
- 复用/新增 schema 描述帮助定位字段错误。
- UI 级别 toast/message 需映射到明确的错误类别，并区分致命/非致命错误。
- 覆盖 Vitest/Playwright 场景，确保不同错误路径都能复现。

## 非目标

- 不改动导出格式（除非为新校验提供 metadata）。
- 不新增后端同步或云校验流程。
- 不改动历史/资源存储结构本身。

## 成功度量

- 误导入后日志/Toast 包含具体原因（至少包含错误类别 + 字段路径/版本号），并向用户说明哪些部分被跳过。
- 所有新错误路径均有单测覆盖，且 `npm run check` 通过。
- 导入正确备份时行为不变。

## 风险与缓解

| 风险                             | 缓解                                                                       |
| -------------------------------- | -------------------------------------------------------------------------- |
| 新校验过严导致合法旧备份无法导入 | 提供版本兼容层：仅在 schema 破坏时阻断，并在 message 中建议升级/导出新备份 |
| 错误信息不一致                   | 为每类错误定义常量或枚举，统一日志与 UI 文案                               |
| 性能回归                         | 校验仅对用户点击导入时运行，可接受；仍需限制文件大小并在解析后尽早 fail    |

## 时间线与里程碑

1. 设计错误分类与 schema（本提案获得批准后 1 天内）。
2. 完成实现 + 单测（2 天）。
3. 更新 Playwright/手动验证脚本（0.5 天）。

## 批准需求

- 需要产品/体验确认文案是否符合预期。
- 需要技术 reviewer 确认 schema 带来的兼容策略。
